<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOPC Staff - CA Input</title>
    <style>
        :root { --blue: #0d47a1; --gold: #fbc02d; --red: #d32f2f; --green: #2e7d32; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--light); padding: 20px; margin: 0; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 4px solid var(--blue); margin-bottom: 25px; padding-bottom: 10px; }
        #authSection { background: #fffde7; padding: 40px; border-radius: 10px; text-align: center; border: 2px dashed var(--blue); }
        .hidden { display: none; }
        .dashboard-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 25px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--blue); color: white; padding: 12px; font-size: 13px; text-transform: uppercase; }
        td { border: 1px solid #eee; padding: 10px; text-align: center; }
        input[type="number"] { width: 60px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; font-size: 16px; }
        .total-box { font-weight: bold; color: var(--blue); background: #e3f2fd; padding: 8px; border-radius: 4px; font-size: 18px; }
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        #syncStatus { font-weight: bold; padding: 5px 10px; border-radius: 20px; background: #eee; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="color:var(--blue); margin:0;">BOLA OLAT PRIVATE COLLEGE</h1>
        <p style="margin:5px 0;">Continuous Assessment (CA) Management Portal</p>
    </div>

    <div id="authSection">
        <h2 style="color:var(--blue);">Staff Login</h2>
        <input type="password" id="staffPin" placeholder="Enter Subject PIN" style="padding:15px; font-size:20px; border:2px solid var(--blue); width: 250px; text-align: center;">
        <br><br>
        <button class="btn" style="background:var(--blue); width:250px;" onclick="verifyAccess()">Access CA Records</button>
    </div>

    <div id="mainPortal" class="hidden">
        <div id="adminControls" class="hidden" style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid var(--blue);">
            <button id="lockBtn" class="btn" style="background:var(--red);" onclick="toggleLock()">ðŸ”’ Freeze Records</button>
            <span style="margin-left:15px; font-weight:bold; color:var(--blue);">PRINCIPAL MODE</span>
        </div>

        <div class="dashboard-controls">
            <div><label><b>Authorized Subject:</b></label><br>
                <select id="subjectSelect" style="width:100%; padding:10px; font-weight:bold;" disabled></select>
            </div>
            <div><label><b>Class:</b></label><br>
                <select id="classSelect" onchange="loadStudents()" style="width:100%; padding:10px; border:1px solid var(--blue);"></select>
            </div>
            <div style="text-align:center;"><label><b>Cloud Sync:</b></label><br>
                <span id="syncStatus" style="color:var(--green);">Ready</span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="text-align:left;">Student Name & ID</th>
                    <th>T1(10)</th>
                    <th>T2(10)</th>
                    <th>Note(10)</th>
                    <th>Ext(5)</th>
                    <th>Int(5)</th>
                    <th style="background:var(--gold); color:black;">CA Total (40)</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRd15pg_DwB6w9KnGmIa2O9gZ_Z21O0GtC90kxeBGbTx-uDcnt9rnQxGwS63zgyeRFTg/exec";

const PERMISSIONS = {
    "A9K2":{sub:"English Language",arm:"Senior"}, "B7M4":{sub:"Digital Technology",arm:"Senior"},
    "Q3F8":{sub:"Mathematics",arm:"Senior"}, "Z2L9":{sub:"Citizenship Education",arm:"Senior"},
    "M4D7":{sub:"Biology",arm:"Senior"}, "X9P2":{sub:"Geography",arm:"Senior"},
    "H6K5":{sub:"Chemistry",arm:"Senior"}, "N1S8":{sub:"Physics",arm:"Senior"},
    "E7W3":{sub:"Further Mathematics",arm:"Senior"}, "J4Q9":{sub:"Agriculture Science",arm:"Senior"},
    "P5T7":{sub:"Economics",arm:"Senior"}, "F9B4":{sub:"Financial Accounting",arm:"Senior"},
    "K3E6":{sub:"Commerce",arm:"Senior"}, "W5M9":{sub:"Literature In English",arm:"Senior"},
    "A6N4":{sub:"Yoruba",arm:"Senior"}, "G8C3":{sub:"Government",arm:"Senior"},
    "R2J7":{sub:"Religious Studies",arm:"Senior"}, "R5C1":{sub:"Basic Technology",arm:"Junior"},
    "C2R6":{sub:"Business Studies",arm:"Junior"}, "S7H2":{sub:"Religious Studies",arm:"Junior"},
    "V9T1":{sub:"Digital Technologies",arm:"Junior"}, "Y4K6":{sub:"English Studies",arm:"Junior"},
    "M7P3":{sub:"French",arm:"Junior"}, "E2L8":{sub:"Intermediate Science",arm:"Junior"},
    "B5S9":{sub:"Mathematics",arm:"Junior"}, "Q6D4":{sub:"Nigerian History",arm:"Junior"},
    "H1W7":{sub:"Physical and Health Education",arm:"Junior"}, "T3F8":{sub:"Pre Vocational Studies",arm:"Junior"},
    "T8A6":{sub:"Social and Citizenship Studies",arm:"Junior"}, "L8V1":{sub:"Social Studies",arm:"Junior"},
    "D1X8":{sub:"Yoruba",arm:"Junior"}, "0099":{sub:"ALL",arm:"Master"}
};

const studentDatabase = {
    "Basic 7": [{n:"Junior Student 1",c:"BOPC/B7/01"}],
    "Senior 1": [{n:"Senior Student 1",c:"BOPC/S1/101"}]
};

let activeUser = ""; let isLocked = false;

function verifyAccess() {
    const pin = document.getElementById('staffPin').value;
    const auth = PERMISSIONS[pin];
    if(auth) {
        activeUser = pin === "0099" ? "PRINCIPAL" : "STAFF-" + auth.sub;
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mainPortal').classList.remove('hidden');
        if(pin === "0099") document.getElementById('adminControls').classList.remove('hidden');
        document.getElementById('subjectSelect').innerHTML = `<option>${auth.sub}</option>`;
        const classes = auth.arm === "Junior" ? ["Basic 7","Basic 8","Basic 9"] : (auth.arm === "Senior" ? ["Senior 1","Senior 2","Senior 3"] : ["Basic 7","Senior 1"]);
        document.getElementById('classSelect').innerHTML = '<option value="">-- Class --</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
    } else alert("Invalid PIN");
}

function loadStudents() {
    const cls = document.getElementById('classSelect').value;
    const body = document.getElementById('studentTableBody');
    body.innerHTML = ""; if(!studentDatabase[cls]) return;
    studentDatabase[cls].forEach(s => {
        body.innerHTML += `<tr>
            <td style="text-align:left;"><b>${s.n}</b><br><small>${s.c}</small>
            <input type="hidden" class="h-name" value="${s.n}"><input type="hidden" class="h-code" value="${s.c}"></td>
            <td><input type="number" class="t1" onchange="processChange(this)"></td>
            <td><input type="number" class="t2" onchange="processChange(this)"></td>
            <td><input type="number" class="note" onchange="processChange(this)"></td>
            <td><input type="number" class="extra" onchange="processChange(this)"></td>
            <td><input type="number" class="inter" onchange="processChange(this)"></td>
            <td class="row-total total-box">0</td></tr>`;
    });
}

function processChange(el) {
    if(isLocked && activeUser !== "PRINCIPAL") return alert("Locked!");
    const row = el.closest('tr');
    const lim = {t1:10, t2:10, note:10, extra:5, inter:5};
    let err = false;
    Object.keys(lim).forEach(k => {
        const i = row.querySelector('.'+k); let v = parseFloat(i.value);
        if(v > lim[k] || v < 0 || isNaN(v)) { err = true; i.style.background = "#ffcdd2"; } else i.style.background = "";
    });
    const tot = row.querySelector('.row-total');
    if(err) { tot.innerText = "ERR"; tot.style.color="red"; return; }
    const total = Array.from(row.querySelectorAll('input[type="number"]')).reduce((a,b) => a+(parseFloat(b.value)||0), 0);
    tot.innerText = total.toFixed(1); tot.style.color="var(--blue)";
    syncToCloud(row, total);
}

async function syncToCloud(row, total) {
    document.getElementById('syncStatus').innerText = "Syncing...";
    try {
        await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({
            staff: activeUser, class: document.getElementById('classSelect').value,
            subject: document.getElementById('subjectSelect').value, name: row.querySelector('.h-name').value,
            code: row.querySelector('.h-code').value, total: total, grade: "CA"
        })});
        document.getElementById('syncStatus').innerText = "Synced âœ”";
        document.getElementById('syncStatus').style.color = "var(--green)";
    } catch (e) { document.getElementById('syncStatus').innerText = "Error!"; }
}

function toggleLock() {
    isLocked = !isLocked;
    const btn = document.getElementById('lockBtn');
    document.querySelectorAll('input[type="number"]').forEach(i => i.disabled = isLocked);
    btn.innerText = isLocked ? "ðŸ”“ Unlock Records" : "ðŸ”’ Freeze Records";
}
</script>
</body>
</html>
