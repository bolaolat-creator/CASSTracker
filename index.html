<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOPC - Cloud Academic Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --blue: #0d47a1; --gold: #fbc02d; --red: #d32f2f; --green: #2e7d32; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Branding & Header */
        .header { text-align: center; border-bottom: 4px solid var(--blue); margin-bottom: 25px; padding-bottom: 15px; }
        .header h1 { margin: 0; color: var(--blue); letter-spacing: 1px; }
        
        /* Auth Gate */
        #authSection { background: #fff9c4; padding: 30px; border-radius: 10px; text-align: center; border: 2px dashed var(--gold); }
        .hidden { display: none; }
        
        /* Dashboard Layout */
        .dashboard-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ddd; }
        
        /* Table Styling */
        table { width: 100%; border-collapse: collapse; background: white; margin-top: 10px; }
        th { background: var(--blue); color: white; padding: 12px; font-size: 13px; text-transform: uppercase; }
        td { border: 1px solid #eee; padding: 10px; text-align: center; }
        .stu-info { text-align: left; font-weight: bold; min-width: 200px; }
        .stu-info small { color: #666; font-weight: normal; }

        /* Inputs */
        input[type="number"] { width: 50px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; }
        input[type="number"]:focus { border-color: var(--blue); outline: none; background: #e3f2fd; }
        .exam-input { background: #fffde7; font-weight: bold; border: 1px solid var(--gold) !important; }

        /* Buttons */
        .btn { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; }
        .btn-sync { background: var(--green); }
        .btn-sync:hover { background: #1b5e20; }
        .btn-auth { background: var(--blue); }
        
        /* Sync Status */
        #syncStatus { font-size: 12px; margin-top: 10px; font-weight: bold; }
        .sync-success { color: var(--green); }
        .sync-pending { color: var(--gold); }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>BOLA OLAT PRIVATE COLLEGE</h1>
        <p>Official Cloud-Synced Academic Management System</p>
    </div>

    <div id="authSection">
        <h3>üîí Secure Teacher/Principal Access</h3>
        <p>Enter your 4-digit Authorization PIN to continue</p>
        <input type="password" id="staffPin" placeholder="Enter PIN" style="padding:12px; border-radius:5px; border:1px solid #ccc; width: 200px; font-size: 18px; text-align: center;">
        <br><br>
        <button class="btn btn-auth" onclick="verifyAccess()">Unlock Portal</button>
        <p id="errorMsg" style="color:red; display:none; margin-top:10px;">Invalid Code. Please contact Administration.</p>
    </div>

    <div id="mainPortal" class="hidden">
        <div class="dashboard-controls">
            <div>
                <label><b>1. Select Academic Arm:</b></label><br>
                <select id="armSelect" onchange="updateSubjects()" style="width:100%; padding:10px; margin-top:5px;">
                    <option value="">-- Choose Arm --</option>
                    <option value="Junior">Junior (Basic 7-9)</option>
                    <option value="Senior">Senior (SS 1-3)</option>
                </select>
            </div>
            <div>
                <label><b>2. Select Class:</b></label><br>
                <select id="classSelect" onchange="loadStudents()" style="width:100%; padding:10px; margin-top:5px;">
                    <option value="">-- Choose Class --</option>
                </select>
            </div>
            <div>
                <label><b>3. Select Subject:</b></label><br>
                <select id="subjectSelect" style="width:100%; padding:10px; margin-top:5px;">
                    <option value="">-- Choose Subject --</option>
                </select>
            </div>
        </div>

        <div id="syncStatus" class="sync-pending">‚óè System Ready (Waiting for data...)</div>

        <table>
            <thead>
                <tr>
                    <th>Student Name & Code</th>
                    <th>T1 (10)</th>
                    <th>T2 (10)</th>
                    <th>Note (10)</th>
                    <th>Ext (5)</th>
                    <th>Int (5)</th>
                    <th>Exam (60)</th>
                    <th>Total (100)</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                </tbody>
        </table>

        <div style="margin-top: 30px; text-align: center; border-top: 1px solid #eee; padding-top: 20px;">
            <p style="font-size: 13px; color: #666;">Data is automatically synced to the Cloud Sheet as you type.</p>
            <button class="btn btn-sync" onclick="manualSync()">üöÄ Forced Cloud Export (Final Save)</button>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwNIvAjbriyn8IG62hObRLiFh8USMQjnT6UzY15AuPKjVeBHwe9a9BVCU91UftpqfNzCQ/exec";

const juniorSubjects = ["Basic Technology", "Business Studies", "Religious Studies", "Digital Technologies", "English Studies", "French", "Intermediate Science", "Mathematics", "Nigerian History", "Physical and Health Education", "Pre Vocational Studies", "Social and Citizenship Studies", "Social Studies", "Yoruba"];
const seniorSubjects = ["English Language", "Digital Technology", "Mathematics", "Citizenship Education", "Biology", "Geography", "Chemistry", "Physics", "Further Mathematics", "Agriculture Science", "Economics", "Financial Accounting", "Commerce", "Literature In English", "Yoruba", "Government", "Religious Studies"];

// Sample Database (Replace with your full list using the Excel formula)
const studentDatabase = {
    "Basic 7": [{n: "Adewale John", c: "BOPC/B7/001"}, {n: "Chukwuma Ngozi", c: "BOPC/B7/002"}],
    "Senior 1": [{n: "Olatunji Bola", c: "BOPC/S1/101"}, {n: "Smith Sarah", c: "BOPC/S1/102"}]
};

let activeUser = "";

// --- AUTH LOGIC ---
function verifyAccess() {
    const pin = document.getElementById('staffPin').value;
    const encoded = btoa(pin);
    // 0099 (Master) or 1212 (Staff)
    if(encoded === "MDA5OQ==" || encoded === "MTIxMg==") {
        activeUser = (encoded === "MDA5OQ==") ? "ADMIN" : "TEACHER-"+pin;
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mainPortal').classList.remove('hidden');
    } else {
        document.getElementById('errorMsg').style.display = "block";
    }
}

// --- UI LOGIC ---
function updateSubjects() {
    const arm = document.getElementById('armSelect').value;
    const subSel = document.getElementById('subjectSelect');
    const classSel = document.getElementById('classSelect');
    
    subSel.innerHTML = '<option value="">-- Choose Subject --</option>';
    classSel.innerHTML = '<option value="">-- Choose Class --</option>';

    const list = arm === "Junior" ? juniorSubjects : seniorSubjects;
    const classes = arm === "Junior" ? ["Basic 7", "Basic 8", "Basic 9"] : ["Senior 1", "Senior 2", "Senior 3"];

    list.forEach(s => subSel.innerHTML += `<option>${s}</option>`);
    classes.forEach(c => classSel.innerHTML += `<option>${c}</option>`);
}

function loadStudents() {
    const cls = document.getElementById('classSelect').value;
    const body = document.getElementById('studentTableBody');
    body.innerHTML = "";
    if(!studentDatabase[cls]) return;

    studentDatabase[cls].forEach(s => {
        body.innerHTML += `<tr>
            <td class="stu-info">${s.n}<br><small>${s.c}</small>
                <input type="hidden" class="h-name" value="${s.n}">
                <input type="hidden" class="h-code" value="${s.c}">
            </td>
            <td><input type="number" class="t1" onchange="processChange(this)" max="10"></td>
            <td><input type="number" class="t2" onchange="processChange(this)" max="10"></td>
            <td><input type="number" class="note" onchange="processChange(this)" max="10"></td>
            <td><input type="number" class="extra" onchange="processChange(this)" max="5"></td>
            <td><input type="number" class="inter" onchange="processChange(this)" max="5"></td>
            <td><input type="number" class="exam exam-input" onchange="processChange(this)" max="60"></td>
            <td class="row-total" style="font-weight:bold;">0</td>
            <td class="row-grade">-</td>
        </tr>`;
    });
}

// --- CALCULATION & CLOUD SYNC ---
function processChange(el) {
    const row = el.closest('tr');
    const t1 = parseFloat(row.querySelector('.t1').value) || 0;
    const t2 = parseFloat(row.querySelector('.t2').value) || 0;
    const note = parseFloat(row.querySelector('.note').value) || 0;
    const extra = parseFloat(row.querySelector('.extra').value) || 0;
    const inter = parseFloat(row.querySelector('.inter').value) || 0;
    const exam = parseFloat(row.querySelector('.exam').value) || 0;

    const total = t1 + t2 + note + extra + inter + exam;
    row.querySelector('.row-total').innerText = total.toFixed(1);

    // Grading Logic
    let g = "F9";
    if(total >= 75) g="A1"; else if(total >= 70) g="B2"; else if(total >= 65) g="B3";
    else if(total >= 60) g="C4"; else if(total >= 55) g="C5"; else if(total >= 50) g="C6";
    else if(total >= 45) g="D7"; else if(total >= 40) g="E8";
    
    const gc = row.querySelector('.row-grade');
    gc.innerText = g;
    gc.style.color = (total >= 40) ? "green" : "red";

    // Trigger Cloud Sync
    syncToCloud(row, total, g);
}

async function syncToCloud(row, total, grade) {
    const status = document.getElementById('syncStatus');
    status.innerText = "‚è≥ Syncing to Cloud...";
    status.className = "sync-pending";

    const payload = {
        staff: activeUser,
        className: document.getElementById('classSelect').value,
        subject: document.getElementById('subjectSelect').value,
        studentName: row.querySelector('.h-name').value,
        code: row.querySelector('.h-code').value,
        total: total,
        grade: grade
    };

    try {
        await fetch(CLOUD_URL, {
            method: 'POST',
            mode: 'no-cors', // Critical for Google Scripts
            body: JSON.stringify(payload)
        });
        status.innerText = "‚úî All data secured in Cloud Sheet";
        status.className = "sync-success";
    } catch (e) {
        status.innerText = "‚ùå Sync Error (Check Internet)";
        status.className = "sync-pending";
    }
}

function manualSync() {
    alert("Manual Sync triggered. System is checking all rows...");
    document.querySelectorAll('#studentTableBody tr').forEach(r => {
        const total = r.querySelector('.row-total').innerText;
        const grade = r.querySelector('.row-grade').innerText;
        if(total > 0) syncToCloud(r, total, grade);
    });
}
</script>

</body>
</html>
