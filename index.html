<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOPC - Master Cloud Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --blue: #0d47a1; --gold: #fbc02d; --red: #d32f2f; --green: #2e7d32; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--light); padding: 20px; color: #333; }
        .container { max-width: 1250px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        .header { text-align: center; border-bottom: 4px solid var(--blue); margin-bottom: 25px; padding-bottom: 15px; }
        .header h1 { margin: 0; color: var(--blue); letter-spacing: 1px; }
        
        #authSection { background: #fff9c4; padding: 30px; border-radius: 10px; text-align: center; border: 2px dashed var(--gold); }
        .hidden { display: none; }
        
        .dashboard-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ddd; }
        
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: var(--blue); color: white; padding: 12px; font-size: 12px; position: sticky; top: 0; }
        td { border: 1px solid #eee; padding: 8px; text-align: center; }
        .stu-info { text-align: left; font-weight: bold; font-size: 13px; }
        
        input[type="number"] { width: 55px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; }
        .exam-input { background: #fffde7; border: 1px solid var(--gold) !important; }
        
        .btn { padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .btn-lock { background: var(--red); }
        .btn-unlock { background: var(--gold); color: black; }

        #summaryDash { margin-top: 20px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-around; border: 2px solid #ddd; transition: 0.5s; }
        .stat-box { text-align: center; }
        .stat-val { font-size: 24px; font-weight: bold; display: block; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>BOLA OLAT PRIVATE COLLEGE</h1>
        <p>Master Cloud Academic Portal & Records</p>
    </div>

    <div id="authSection">
        <h3>ðŸ”’ Secure Access</h3>
        <input type="password" id="staffPin" placeholder="Enter PIN" style="padding:12px; border-radius:5px; text-align:center; font-size:18px;">
        <button class="btn" style="background:var(--blue);" onclick="verifyAccess()">Unlock Portal</button>
    </div>

    <div id="mainPortal" class="hidden">
        <div id="adminControls" class="hidden" style="background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid var(--blue);">
            <button id="lockBtn" class="btn btn-lock" onclick="toggleLock()">ðŸ”’ Freeze Records</button>
            <span style="margin-left:15px; font-weight:bold; color:var(--blue);">PRINCIPAL MASTER MODE</span>
        </div>

        <div class="dashboard-controls">
            <div>
                <label><b>Academic Arm:</b></label><br>
                <select id="armSelect" onchange="updateSubjects()" style="width:100%; padding:10px;">
                    <option value="">-- Select --</option>
                    <option value="Junior">Junior (Basic 7-9)</option>
                    <option value="Senior">Senior (SS 1-3)</option>
                </select>
            </div>
            <div>
                <label><b>Specific Class:</b></label><br>
                <select id="classSelect" onchange="loadStudents()" style="width:100%; padding:10px;">
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div>
                <label><b>Subject:</b></label><br>
                <select id="subjectSelect" style="width:100%; padding:10px;">
                    <option value="">-- Select --</option>
                </select>
            </div>
            <div style="text-align:center;">
                <label><b>Sync Status:</b></label><br>
                <span id="syncStatus" style="font-weight:bold; color:var(--gold);">Ready</span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Student Details</th>
                    <th>T1(10)</th>
                    <th>T2(10)</th>
                    <th>Note(10)</th>
                    <th>Ext(5)</th>
                    <th>Int(5)</th>
                    <th>Exam(60)</th>
                    <th>Total(100)</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>

        <div id="summaryDash">
            <div class="stat-box">
                <span class="stat-val" id="statTotal">0</span>
                <small>Students</small>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="statSynced" style="color:var(--green);">0</span>
                <small>Synced</small>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="statErrors" style="color:var(--red);">0</span>
                <small>Errors to Fix</small>
            </div>
        </div>
    </div>
</div>

<script>
// --- CONFIGURATION ---
const CLOUD_URL = "https://script.google.com/macros/s/AKfycbwNIvAjbriyn8IG62hObRLiFh8USMQjnT6UzY15AuPKjVeBHwe9a9BVCU91UftpqfNzCQ/exec";
let activeUser = "";
let isLocked = false;

const juniorSubjects = ["Basic Technology", "Business Studies", "Religious Studies", "Digital Technologies", "English Studies", "French", "Intermediate Science", "Mathematics", "Nigerian History", "Physical and Health Education", "Pre Vocational Studies", "Social and Citizenship Studies", "Social Studies", "Yoruba"];
const seniorSubjects = ["English Language", "Digital Technology", "Mathematics", "Citizenship Education", "Biology", "Geography", "Chemistry", "Physics", "Further Mathematics", "Agriculture Science", "Economics", "Financial Accounting", "Commerce", "Literature In English", "Yoruba", "Government", "Religious Studies"];

const studentDatabase = {
    "Basic 7": [{n: "Adewale John", c: "BOPC/B7/01"}, {n: "Chukwuma Ngozi", c: "BOPC/B7/02"}],
    "Senior 1": [{n: "Olatunji Bola", c: "BOPC/S1/101"}, {n: "Smith Sarah", c: "BOPC/S1/102"}]
    // ADD ALL CLASSES HERE
};

// --- AUTH & LOCKING ---
function verifyAccess() {
    const pin = document.getElementById('staffPin').value;
    const enc = btoa(pin);
    if(enc === "MDA5OQ==" || enc === "MTIxMg==") { // 0099 or 1212
        activeUser = (enc === "MDA5OQ==") ? "ADMIN" : "STAFF-"+pin;
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mainPortal').classList.remove('hidden');
        if(enc === "MDA5OQ==") document.getElementById('adminControls').classList.remove('hidden');
    } else { alert("Invalid PIN"); }
}

function toggleLock() {
    isLocked = !isLocked;
    const btn = document.getElementById('lockBtn');
    document.querySelectorAll('input[type="number"]').forEach(i => i.disabled = isLocked);
    btn.innerText = isLocked ? "ðŸ”“ Unlock Records" : "ðŸ”’ Freeze Records";
    btn.className = isLocked ? "btn btn-unlock" : "btn btn-lock";
}

// --- CORE LOGIC ---
function updateSubjects() {
    const arm = document.getElementById('armSelect').value;
    const subSel = document.getElementById('subjectSelect');
    const classSel = document.getElementById('classSelect');
    subSel.innerHTML = '<option>-- Select --</option>';
    classSel.innerHTML = '<option>-- Select --</option>';
    const list = arm === "Junior" ? juniorSubjects : seniorSubjects;
    const levels = arm === "Junior" ? ["Basic 7", "Basic 8", "Basic 9"] : ["Senior 1", "Senior 2", "Senior 3"];
    list.forEach(s => subSel.innerHTML += `<option>${s}</option>`);
    levels.forEach(l => classSel.innerHTML += `<option>${l}</option>`);
}

function loadStudents() {
    const cls = document.getElementById('classSelect').value;
    const body = document.getElementById('studentTableBody');
    body.innerHTML = "";
    if(!studentDatabase[cls]) return;
    studentDatabase[cls].forEach(s => {
        body.innerHTML += `<tr>
            <td class="stu-info">${s.n}<br><small>${s.c}</small>
                <input type="hidden" class="h-name" value="${s.n}"><input type="hidden" class="h-code" value="${s.c}">
            </td>
            <td><input type="number" class="t1" onchange="processChange(this)"></td>
            <td><input type="number" class="t2" onchange="processChange(this)"></td>
            <td><input type="number" class="note" onchange="processChange(this)"></td>
            <td><input type="number" class="extra" onchange="processChange(this)"></td>
            <td><input type="number" class="inter" onchange="processChange(this)"></td>
            <td><input type="number" class="exam exam-input" onchange="processChange(this)"></td>
            <td class="row-total">0</td><td class="row-grade">-</td>
        </tr>`;
    });
    updateSummary();
}

function processChange(el) {
    if(isLocked && activeUser !== "ADMIN") { alert("Record is Locked!"); location.reload(); return; }
    
    const row = el.closest('tr');
    let hasError = false;
    const limits = { t1:10, t2:10, note:10, extra:5, inter:5, exam:60 };

    Object.keys(limits).forEach(k => {
        const inp = row.querySelector('.'+k);
        let val = parseFloat(inp.value.replace(/[^0-9.]/g, ''));
        inp.value = isNaN(val) ? "" : val; 
        if(val > limits[k] || val < 0) { hasError = true; inp.style.background = "#ffcdd2"; } 
        else { inp.style.background = ""; }
    });

    const totalCell = row.querySelector('.row-total');
    if(hasError) { 
        totalCell.innerText = "ERR"; totalCell.style.color = "red"; 
        updateSummary(); return; 
    }

    const scores = Array.from(row.querySelectorAll('input[type="number"]')).map(i => parseFloat(i.value)||0);
    const total = scores.reduce((a,b) => a+b, 0);
    totalCell.innerText = total.toFixed(1);
    totalCell.style.color = "black";

    let g = "F9";
    if(total >= 75) g="A1"; else if(total >= 70) g="B2"; else if(total >= 65) g="B3";
    else if(total >= 60) g="C4"; else if(total >= 55) g="C5"; else if(total >= 50) g="C6";
    else if(total >= 45) g="D7"; else if(total >= 40) g="E8";
    row.querySelector('.row-grade').innerText = g;

    updateSummary();
    syncToCloud(row, total, g);
}

function updateSummary() {
    const rows = document.querySelectorAll('#studentTableBody tr');
    let err = 0, sync = 0;
    rows.forEach(r => {
        const t = r.querySelector('.row-total').innerText;
        if(t === "ERR") err++; else if(parseFloat(t) > 0) sync++;
    });
    document.getElementById('statTotal').innerText = rows.length;
    document.getElementById('statErrors').innerText = err;
    document.getElementById('statSynced').innerText = sync;
    document.getElementById('summaryDash').style.borderColor = err > 0 ? "var(--red)" : "var(--green)";
}

async function syncToCloud(row, total, grade) {
    const status = document.getElementById('syncStatus');
    status.innerText = "Syncing...";
    try {
        await fetch(CLOUD_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({
                staff: activeUser,
                class: document.getElementById('classSelect').value,
                subject: document.getElementById('subjectSelect').value,
                name: row.querySelector('.h-name').value,
                code: row.querySelector('.h-code').value,
                total: total,
                grade: grade
            })
        });
        status.innerText = "Cloud Synced âœ”";
        status.style.color = "var(--green)";
    } catch (e) { status.innerText = "Sync Error!"; status.style.color = "var(--red)"; }
}
</script>
</body>
</html>
