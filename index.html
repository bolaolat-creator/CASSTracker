<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BOPC - Secure CA & Grading Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --blue: #0d47a1; --gold: #fbc02d; --red: #d32f2f; --green: #2e7d32; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1100px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid var(--blue); margin-bottom: 25px; padding-bottom: 10px; }
        
        /* Security Overlay */
        #authOverlay { background: #fffde7; padding: 25px; border-radius: 10px; border: 2px dashed var(--blue); margin-bottom: 20px; text-align: center; transition: 0.3s; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { background: var(--blue); color: white; padding: 12px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        
        .main-content { opacity: 0.2; pointer-events: none; transition: 0.5s; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin: 5px; color: white; }
        .btn-calc { background: var(--blue); }
        .btn-save { background: var(--gold); color: black; }
        .btn-add { background: var(--green); }
        
        .remark-box { margin-top: 20px; padding: 15px; border-left: 5px solid var(--gold); background: #fff9c4; font-style: italic; display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0; color:var(--blue);">BOLA OLAT PRIVATE COLLEGE</h1>
        <p><strong>Secure Continuous Assessment & Grading Portal</strong></p>
    </div>

    <div id="authOverlay">
        <h3 id="lockTitle">ðŸ”’ Portal Locked</h3>
        <div id="inputArea">
            <input type="password" id="pinInput" placeholder="Enter Staff PIN" style="padding:10px; border-radius:5px; border:1px solid #ccc; text-align:center;">
            <button class="btn btn-calc" onclick="checkAccess()">Unlock System</button>
            <p id="errorMsg" style="color:red; display:none; font-size:12px;">Access Denied: Invalid Authorization Code</p>
        </div>
    </div>

    <div id="mainPortal" class="main-content">
        <div style="display: flex; gap: 20px; margin-bottom: 20px;">
            <input type="text" id="stuName" placeholder="Student Full Name" style="flex: 2; padding: 10px; border: 1px solid #ccc;">
            <input type="text" id="stuClass" placeholder="Class" style="flex: 1; padding: 10px; border: 1px solid #ccc;">
        </div>

        <table>
            <thead>
                <tr>
                    <th>Subject</th>
                    <th>T1 (10)</th>
                    <th>T2 (10)</th>
                    <th>Notes (10)</th>
                    <th>Extra (5)</th>
                    <th>Interact (5)</th>
                    <th>Total (40)</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="caBody">
                <tr>
                    <td><input type="text" class="subj-name" placeholder="Subject Name"></td>
                    <td><input type="number" class="t1" oninput="runLogic(this)" max="10"></td>
                    <td><input type="number" class="t2" oninput="runLogic(this)" max="10"></td>
                    <td><input type="number" class="note" oninput="runLogic(this)" max="10"></td>
                    <td><input type="number" class="extra" oninput="runLogic(this)" max="5"></td>
                    <td><input type="number" class="inter" oninput="runLogic(this)" max="5"></td>
                    <td class="row-total" style="font-weight:bold;">0</td>
                    <td class="row-grade">-</td>
                </tr>
            </tbody>
        </table>

        <div id="principalRemark" class="remark-box">
            <strong>Principal's Official Remark:</strong> <span id="remarkText"></span>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <button class="btn btn-add" onclick="addRow()">+ Add Subject</button>
            <button class="btn btn-calc" onclick="generateVisuals()">Analyze Performance</button>
            <button class="btn btn-save" onclick="exportCSV()">ðŸ’¾ Export & Secure Data</button>
        </div>
        
        <canvas id="caChart" style="margin-top:30px; display:none;"></canvas>
    </div>
</div>

<script>
    // SECURITY: Obfuscated Codes (Base64)
    // Teacher PINs: 1212, 3434 | Principal PIN: 0099
    const _0x4f22 = ["MTIxMg==", "MzQzNA=="]; 
    const _0x5a11 = "MDA5OQ=="; 
    let currentUser = "";

    function checkAccess() {
        const input = document.getElementById('pinInput').value;
        const encoded = btoa(input);
        const error = document.getElementById('errorMsg');

        if (encoded === _0x5a11) {
            currentUser = "PRINCIPAL-MASTER";
            unlock("ðŸ‘‘ MASTER ACCESS: Principal Mode", "#e3f2fd");
            document.getElementById('principalRemark').style.display = "block";
        } else if (_0x4f22.includes(encoded)) {
            currentUser = "TEACHER-" + input;
            unlock("âœ… AUTHORIZED: Teacher Mode", "#e8f5e9");
        } else {
            error.style.display = "block";
        }
    }

    function unlock(msg, color) {
        document.getElementById('authOverlay').style.backgroundColor = color;
        document.getElementById('lockTitle').innerText = msg;
        document.getElementById('inputArea').style.display = "none";
        document.getElementById('mainPortal').style.opacity = "1";
        document.getElementById('mainPortal').style.pointerEvents = "auto";
    }

    function addRow() {
        const row = `<tr>
            <td><input type="text" class="subj-name" placeholder="Subject Name"></td>
            <td><input type="number" class="t1" oninput="runLogic(this)" max="10"></td>
            <td><input type="number" class="t2" oninput="runLogic(this)" max="10"></td>
            <td><input type="number" class="note" oninput="runLogic(this)" max="10"></td>
            <td><input type="number" class="extra" oninput="runLogic(this)" max="5"></td>
            <td><input type="number" class="inter" oninput="runLogic(this)" max="5"></td>
            <td class="row-total" style="font-weight:bold;">0</td>
            <td class="row-grade">-</td>
        </tr>`;
        document.getElementById('caBody').insertAdjacentHTML('beforeend', row);
    }

    function runLogic(el) {
        const row = el.closest('tr');
        const scores = [
            parseFloat(row.querySelector('.t1').value) || 0,
            parseFloat(row.querySelector('.t2').value) || 0,
            parseFloat(row.querySelector('.note').value) || 0,
            parseFloat(row.querySelector('.extra').value) || 0,
            parseFloat(row.querySelector('.inter').value) || 0
        ];
        
        const total = scores.reduce((a, b) => a + b, 0);
        const totalCell = row.querySelector('.row-total');
        const gradeCell = row.querySelector('.row-grade');
        
        totalCell.innerText = total.toFixed(1);

        // Grade Mapping
        let grade = "F";
        if (total >= 32) grade = "A (Distinction)";
        else if (total >= 26) grade = "B (Credit)";
        else if (total >= 20) grade = "C (Pass)";
        else if (total >= 16) grade = "P (Pass)";
        
        gradeCell.innerText = grade;
        gradeCell.style.color = total >= 20 ? "green" : "red";

        updatePrincipalRemark();
    }

    function updatePrincipalRemark() {
        const totals = Array.from(document.querySelectorAll('.row-total')).map(td => parseFloat(td.innerText));
        const avg = totals.reduce((a,b) => a+b, 0) / totals.length;
        let remark = "Awaiting full entry.";
        
        if (avg >= 30) remark = "Brilliant results. Student is an asset to the college.";
        else if (avg >= 20) remark = "Good effort. Focus more on consistency in Note Taking.";
        else remark = "Weak CA performance. Urgent parental meeting required.";
        
        document.getElementById('remarkText').innerText = remark;
    }

    function generateVisuals() {
        const canvas = document.getElementById('caChart');
        canvas.style.display = "block";
        const labels = Array.from(document.querySelectorAll('.subj-name')).map(i => i.value || "Subj");
        const data = Array.from(document.querySelectorAll('.row-total')).map(td => parseFloat(td.innerText));

        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'CA Total (Out of 40)', data: data, backgroundColor: '#0d47a1' }]
            }
        });
        canvas.scrollIntoView({behavior: 'smooth'});
    }

    function exportCSV() {
        let csv = "AuthID,Student,Subject,Total,Grade\n";
        const name = document.getElementById('stuName').value || "Student";
        document.querySelectorAll('#caBody tr').forEach(r => {
            csv += `${currentUser},${name},${r.querySelector('.subj-name').value},${r.querySelector('.row-total').innerText},${r.querySelector('.row-grade').innerText}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `BOPC_CA_${name}.csv`;
        a.click();
    }
</script>
</body>
</html>
