<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOPC Staff - Secure CA Portal</title>
    <style>
        :root { --blue: #0d47a1; --gold: #fbc02d; --red: #d32f2f; --green: #2e7d32; --light: #f4f7f6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--light); padding: 20px; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); position: relative; }
        .header { text-align: center; border-bottom: 4px solid var(--blue); margin-bottom: 25px; padding-bottom: 10px; }
        #authSection { background: #fffde7; padding: 50px; border-radius: 10px; text-align: center; border: 2px dashed var(--blue); max-width: 400px; margin: 50px auto; }
        .hidden { display: none; }
        .dashboard-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; background: #f9f9f9; padding: 20px; border-radius: 10px; margin-bottom: 25px; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; }
        th { background: var(--blue); color: white; padding: 15px; font-size: 13px; text-transform: uppercase; }
        td { border: 1px solid #eee; padding: 10px; text-align: center; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        input[type="number"] { width: 60px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; text-align: center; font-weight: bold; font-size: 16px; }
        .total-box { font-weight: 800; color: var(--blue); background: #e3f2fd; padding: 10px; border-radius: 4px; font-size: 18px; display: inline-block; min-width: 50px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; transition: 0.3s; }
        .logout-btn { background: var(--red); position: absolute; right: 20px; top: 20px; font-size: 12px; }
        #syncStatus { font-weight: bold; padding: 8px 15px; border-radius: 20px; background: #eee; font-size: 14px; }
        .status-syncing { background: #fff9c4 !important; color: #f57f17; }
        .status-success { background: #c8e6c9 !important; color: #2e7d32; }
    </style>
</head>
<body>

<div class="container">
    <button id="logoutBtn" class="btn logout-btn hidden" onclick="logout()">LOGOUT</button>
    
    <div class="header">
        <h1 style="color:var(--blue); margin:0;">BOLA OLAT PRIVATE COLLEGE</h1>
        <p style="margin:5px 0; font-weight: bold; color: #555;">STAFF CA PORTAL - SECURE ACCESS</p>
    </div>

    <div id="authSection">
        <h2 style="color:var(--blue); margin-top:0;">Teacher Login</h2>
        <input type="password" id="staffPin" placeholder="Enter Subject PIN" style="padding:15px; font-size:20px; border:2px solid var(--blue); width: 100%; text-align: center; border-radius: 8px; box-sizing: border-box;">
        <br><br>
        <button class="btn" style="background:var(--blue); width:100%;" onclick="verifyAccess()">Access My Classes</button>
    </div>

    <div id="mainPortal" class="hidden">
        <div class="dashboard-controls">
            <div>
                <label><b>Authorized Subject:</b></label>
                <div id="subjectLabel" style="padding:10px; font-weight:bold; color:var(--blue); background:#e3f2fd; border-radius:5px; border:1px solid #bbdefb; margin-top:5px;"></div>
            </div>
            <div>
                <label><b>Select Assigned Class:</b></label>
                <select id="classSelect" onchange="loadStudents()" style="width:100%; padding:10px; border:1px solid var(--blue); border-radius: 5px; margin-top:5px; font-weight:bold;"></select>
            </div>
            <div style="text-align:center;">
                <label><b>Database Sync:</b></label><br>
                <div style="margin-top:10px;"><span id="syncStatus">Ready to Record</span></div>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="text-align:left; width: 30%;">Student Name & ID</th>
                    <th>T1 (10)</th><th>T2 (10)</th><th>Note (10)</th><th>Ext (5)</th><th>Int (5)</th>
                    <th style="background:var(--gold); color:black;">Total (40)</th>
                </tr>
            </thead>
            <tbody id="studentTableBody"></tbody>
        </table>
    </div>
</div>

<script>
// REPLACE WITH YOUR NEW GOOGLE APPS SCRIPT URL
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxsZDHV5K0zBIEMx7aJhcfR_Qph3Yc9MBC92K3D6lDt0Wuayighefhv8TBJJlzxoAbVrg/exec";

// Permission mapping
const PERMISSIONS = {
    "QTlLMg==": {sub: "English Language", arm: "Senior"}, "UTNGOA==": {sub: "Mathematics", arm: "Senior"},
    "QjdNNA==": {sub: "Digital Tech", arm: "Senior"}, "WjJMOQ==": {sub: "Citizenship Ed", arm: "Senior"},
    "TTRENw==": {sub: "Biology", arm: "Senior"}, "WDlQMg==": {sub: "Geography", arm: "Senior"},
    "SDZLNQ==": {sub: "Chemistry", arm: "Senior"}, "TjFTOA==": {sub: "Physics", arm: "Senior"},
    "RTdXMw==": {sub: "Further Maths", arm: "Senior"}, "SjRROQ==": {sub: "Agric Science", arm: "Senior"},
    "UDVUNw==": {sub: "Economics", arm: "Senior"}, "RjlCNA==": {sub: "Accounting", arm: "Senior"},
    "SzNFNg==": {sub: "Commerce", arm: "Senior"}, "VzVNOQ==": {sub: "Literature", arm: "Senior"},
    "QTZONA==": {sub: "Yoruba", arm: "Senior"}, "RzhDMw==": {sub: "Government", arm: "Senior"},
    "UjJKNw==": {sub: "CRS/IRS", arm: "Senior"}, "QjVTOQ==": {sub: "Mathematics", arm: "Junior"},
    "WTRLNg==": {sub: "English Studies", arm: "Junior"}, "UjVDMQ==": {sub: "Basic Tech", arm: "Junior"},
    "QzJSNg==": {sub: "Business Studies", arm: "Junior"}, "UzdIMg==": {sub: "CRS/IRS", arm: "Junior"},
    "VjlUMQ==": {sub: "Digital Tech", arm: "Junior"}, "TTdQMw==": {sub: "French", arm: "Junior"},
    "RTJMOA==": {sub: "Int. Science", arm: "Junior"}, "UTZENA==": {sub: "History", arm: "Junior"},
    "SDFXNw==": {sub: "PHE", arm: "Junior"}, "VDNGOA==": {sub: "Pre-Vocational", arm: "Junior"},
    "VDhBNg==": {sub: "Social/Citizen", arm: "Junior"}, "TDhWMQ==": {sub: "Social Studies", arm: "Junior"},
    "RDFYOA==": {sub: "Yoruba", arm: "Junior"}, "MDA5OQ==": {sub: "Principal/Admin", arm: "Master"}
};

// Student Database (Shortened for preview, use your full version)
const studentDatabase = {
    "Senior 1": [
        {"n": "JOY EKELEDO", "c": "BOC1086"}, {"n": "BADIROT HAMZA", "c": "BOC1037"}, {"n": "ISRAEL IFEANYI", "c": "BOC1048"}, {"n": "FIFUNMI IGBALAJOBI", "c": "BOC1088"}, {"n": "MIRACLE UBILAMA", "c": "BOC1089"}, {"n": "AYOOLA KASUMU", "c": "BOC1053"}, {"n": "DAVID NWEKE", "c": "BOC1057"}, {"n": "IFECHUKWU NWOSU", "c": "BOC1090"}, {"n": "PRECIOUS OGBOCHUKWU", "c": "BOC1064"}, {"n": "ABDULLAHI OGEDE", "c": "BOC1054"}, {"n": "BUSOLA OGUNDELE", "c": "BOC1051"}, {"n": "MOYINOLUWA OGUNYOYE", "c": "BOC1031"}, {"n": "SOMTOCHUKWU OKAFOR", "c": "BOC1047"}, {"n": "DANIEL ONU", "c": "BOC1038"}, {"n": "EMMANUEL OSSAI", "c": "BOC1027"}, {"n": "ESTHER SHOYOYE", "c": "BOC1092"}, {"n": "MOYINOLUWA WHINGAN", "c": "BOC1041"}, {"n": "BRYAN OGUNSHOLA", "c": "BOC1128"}, {"n": "BASIRAT ADEDAPO", "c": "BOC1045"}, {"n": "KUYE ABDULQUDDUS", "c": "BOC1040"}, {"n": "MUNIRAT AGUNBIADE-KOSOKO", "c": "BOC1030"}, {"n": "ABDULLATEEF ALAKA", "c": "BOC1072"}, {"n": "OPEYEMI AKINNIBOSUN", "c": "BOC1171"}, {"n": "ZAINAB NASIRU", "c": "BOC1173"}, {"n": "ABRAHAM EMEKA", "c": "BOC1209"}, {"n": "NIFEMI ADETORO", "c": "BOC1022"}, {"n": "LEKAN BABATUNDE", "c": "BOC1029"}, {"n": "UMAR BALOGUN", "c": "BOC1039"}, {"n": "NOJIAT DAWODU", "c": "BOC1043"}, {"n": "HABEEB DAUDA", "c": "BOC1052"}, {"n": "FATHIA AJAYI", "c": "BOC1083"}, {"n": "ENIOLA AKINRINMADE", "c": "BOC1084"}, {"n": "DEBORAH BABATIMILEYIN", "c": "BOC1085"}, {"n": "GODSWILL JAMES", "c": "BOC1236"}, {"n": "SHAMSONDEEN ODUGUWA", "c": "BOC1238"}, {"n": "WALIYAH MUSA", "c": "BOC1243"}, {"n": "CHIDINMA OGUGUA", "c": "BOC1244"}, {"n": "TAOFEEK OLUDAISI", "c": "BOC1245"}, {"n": "AL-AMEEN  DAWODU", "c": "BOC1253"}, {"n": "OLUWAPAMILERIN IGE", "c": "BOC1254"}, {"n": "SEMILORE MUSEDIK", "c": "BOC1262"}, {"n": "ALIYAH OLADEJI", "c": "BOC1266"}, {"n": "TEMILOLUWA KASALI", "c": "BOC1269"}, {"n": "ROFIAT ADENEKAN", "c": "BOC1275"}
    ],
    "Senior 2": [
        {"n": "ADEMOLA ADEAGBO", "c": "BOC997"}, {"n": "MOHAMMED ADEBAYO", "c": "BOC1082"}, {"n": "AYOMIDE ADELANWA", "c": "BOC1093"}, {"n": "MOJOLA ADEYEMO", "c": "BOC1004"}, {"n": "AYOMIKUN AKINMOYE", "c": "BOC1025"}, {"n": "BOLUWATIFE BALOGUN", "c": "BOC1018"}, {"n": "JABACHIMMA CHUKWU", "c": "BOC1079"}, {"n": "GRACE EKELEDO", "c": "BOC1087"}, {"n": "TIMILEYIN FOLORUNSHO", "c": "BOC1063"}, {"n": "BAZEET HAMZA", "c": "BOC999"}, {"n": "MALIK LAWAL", "c": "BOC1077"}, {"n": "JOSHUA OLAJIDE", "c": "BOC1060"}, {"n": "BOLUWATIFE OLANIRAN", "c": "BOC1036"}, {"n": "EMMANUEL OYEKOLA", "c": "BOC1006"}, {"n": "SAHEED AGUNBIADE-KOSOKO", "c": "BOC1017"}, {"n": "Divine Okike", "c": "BOC1148"}, {"n": "IREMIDE MUSEDIK", "c": "BOC1174"}, {"n": "ABDULKHALIQ OLADELE", "c": "BOC1175"}, {"n": "HAMEED OSENI", "c": "BOC1177"}, {"n": "JOSHUA KUFO", "c": "BOC1178"}, {"n": "IFEDAYO ILESANMI", "c": "BOC1179"}, {"n": "SOPHIA OKONKWO", "c": "BOC1182"}, {"n": "EMMANUEL AMEH", "c": "BOC1191"}, {"n": "FATHIA YUSSUF", "c": "BOC1208"}, {"n": "MICHEL UMOH", "c": "BOC1210"}, {"n": "Habeeb Alade", "c": "BOC1219"}, {"n": "OPEYEMI FASHANU", "c": "BOC1233"}, {"n": "DAVID KOLADE", "c": "BOC1250"}, {"n": "AISHA BELLO", "c": "BOC1255"}, {"n": "ENIOLA ADEWUNMI", "c": "BOC1268"}
    ],
    // Add other classes here as in your original file...
};

let activeUser = "";
let allowedArm = "";

function verifyAccess() {
    const rawPin = document.getElementById('staffPin').value;
    const encodedInput = btoa(rawPin);
    const auth = PERMISSIONS[encodedInput];
    
    if(auth) {
        activeUser = "Staff-" + auth.sub;
        allowedArm = auth.arm;
        
        document.getElementById('authSection').classList.add('hidden');
        document.getElementById('mainPortal').classList.remove('hidden');
        document.getElementById('logoutBtn').classList.remove('hidden');
        document.getElementById('subjectLabel').innerText = auth.sub;
        
        const classSelect = document.getElementById('classSelect');
        classSelect.innerHTML = '<option value="">-- Choose Class --</option>';
        
        let classes = [];
        if(allowedArm === "Junior") classes = ["Basic 7", "Basic 8", "Basic 9"];
        else if(allowedArm === "Senior") classes = ["Senior 1", "Senior 2", "Senior 3"];
        else if(allowedArm === "Master") classes = ["Basic 7", "Basic 8", "Basic 9", "Senior 1", "Senior 2", "Senior 3"];
        
        classes.forEach(cls => {
            let opt = document.createElement('option');
            opt.value = cls; opt.innerText = cls;
            classSelect.appendChild(opt);
        });
    } else { alert("Invalid PIN. Access Denied."); }
}

function loadStudents() {
    const cls = document.getElementById('classSelect').value;
    const body = document.getElementById('studentTableBody');
    body.innerHTML = ""; 
    if(!studentDatabase[cls]) return;

    studentDatabase[cls].forEach(s => {
        body.innerHTML += `<tr>
            <td style="text-align:left;">
                <span style="font-weight:600; color:#333;">${s.n}</span><br>
                <small style="color:#666;">ID: ${s.c}</small>
                <input type="hidden" class="h-name" value="${s.n}">
                <input type="hidden" class="h-code" value="${s.c}">
            </td>
            <td><input type="number" class="t1" value="0" min="0" max="10" onchange="processChange(this)"></td>
            <td><input type="number" class="t2" value="0" min="0" max="10" onchange="processChange(this)"></td>
            <td><input type="number" class="note" value="0" min="0" max="10" onchange="processChange(this)"></td>
            <td><input type="number" class="extra" value="0" min="0" max="5" onchange="processChange(this)"></td>
            <td><input type="number" class="inter" value="0" min="0" max="5" onchange="processChange(this)"></td>
            <td><div class="row-total total-box">0.0</div></td>
        </tr>`;
    });
}

function processChange(el) {
    const row = el.closest('tr');
    const limits = {t1:10, t2:10, note:10, extra:5, inter:5};
    let hasError = false;

    Object.keys(limits).forEach(key => {
        const input = row.querySelector('.' + key);
        let val = parseFloat(input.value) || 0;
        if(val > limits[key] || val < 0) {
            hasError = true; input.style.border = "2px solid red";
        } else { input.style.border = "1px solid #ccc"; }
    });

    const totalDisplay = row.querySelector('.row-total');
    if(hasError) { totalDisplay.innerText = "ERR"; return; }

    const total = Array.from(row.querySelectorAll('input[type="number"]'))
                      .reduce((a, b) => a + (parseFloat(b.value) || 0), 0);
    totalDisplay.innerText = total.toFixed(1);

    // Call the sync function to save individual scores to the cloud
    syncToCloud(row);
}

async function syncToCloud(row) {
    const statusEl = document.getElementById('syncStatus');
    statusEl.innerText = "☁ Saving...";
    statusEl.className = "status-syncing";

    try {
        const payload = {
            staff: activeUser,
            class: document.getElementById('classSelect').value,
            subject: document.getElementById('subjectLabel').innerText,
            name: row.querySelector('.h-name').value,
            code: row.querySelector('.h-code').value,
            // Send individual components to the database
            t1: row.querySelector('.t1').value,
            t2: row.querySelector('.t2').value,
            note: row.querySelector('.note').value,
            ext: row.querySelector('.extra').value,
            int: row.querySelector('.inter').value
        };

        await fetch(SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(payload)
        });
        
        statusEl.innerText = "✔ Record Updated"; 
        statusEl.className = "status-success";
    } catch (e) { 
        statusEl.innerText = "❌ Connection Error"; 
    }
}

function logout() {
    location.reload();
}
</script>
</body>
</html>
