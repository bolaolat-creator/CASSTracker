<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BOPC - Database CA Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --blue: #0d47a1; --gold: #fbc02d; --red: #d32f2f; --green: #2e7d32; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid var(--blue); margin-bottom: 25px; padding-bottom: 10px; }
        #authOverlay { background: #fffde7; padding: 25px; border-radius: 10px; border: 2px dashed var(--blue); text-align: center; margin-bottom: 20px; }
        .main-content { display:none; opacity: 0; transition: 0.5s; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: var(--blue); color: white; padding: 10px; font-size: 12px; }
        td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        .stu-info { text-align: left; min-width: 200px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-calc { background: var(--blue); }
        .btn-save { background: var(--gold); color: black; }
        input[type="number"] { width: 45px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1 style="margin:0; color:var(--blue);">BOLA OLAT PRIVATE COLLEGE</h1>
        <p><strong>Database-Driven Continuous Assessment Portal</strong></p>
    </div>

    <div id="authOverlay">
        <h3 id="lockTitle">ðŸ”’ Teacher Authorization Required</h3>
        <input type="password" id="pinInput" placeholder="Enter Staff PIN" style="padding:10px; border-radius:5px; border:1px solid #ccc;">
        <button class="btn btn-calc" onclick="checkAccess()">Unlock</button>
    </div>

    <div id="mainPortal" class="main-content">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; background: #f9f9f9; padding: 15px; border-radius: 8px;">
            <div>
                <label><b>Select Subject:</b></label><br>
                <select id="subjectSelect" style="width:100%; padding:8px;">
                    <option>Mathematics</option>
                    <option>English Language</option>
                    <option>Biology</option>
                    <option>Economics</option>
                </select>
            </div>
            <div>
                <label><b>Select Class:</b></label><br>
                <select id="classSelect" onchange="loadClassList()" style="width:100%; padding:8px;">
                    <option value="">-- Choose Class --</option>
                    <option value="JSS 1">JSS 1</option>
                    <option value="SSS 1">SSS 1</option>
                </select>
            </div>
            <div style="text-align: right;">
                <label><b>Authorized Staff:</b></label><br>
                <span id="staffIDDisplay" style="font-weight:bold; color:var(--green);"></span>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>Student Name & Code</th>
                    <th>T1 (10)</th>
                    <th>T2 (10)</th>
                    <th>Notes (10)</th>
                    <th>Extra (5)</th>
                    <th>Inter (5)</th>
                    <th>Total (40)</th>
                    <th>Grade</th>
                </tr>
            </thead>
            <tbody id="caBody">
                </tbody>
        </table>

        <div style="margin-top: 30px; text-align: center;">
            <button class="btn btn-calc" onclick="generateVisuals()">Show Class Analytics</button>
            <button class="btn btn-save" onclick="exportCSV()">ðŸ’¾ Save & Export Scores</button>
        </div>
        <canvas id="caChart" style="margin-top:30px; max-height: 300px; display:none;"></canvas>
    </div>
</div>

<script>
    // --- THE STUDENT DATABASE ---
    const studentDatabase = {
        "JSS 1": [
            { name: "Adewale John", code: "BOPC/J1/001" },
            { name: "Chukwuma Ngozi", code: "BOPC/J1/002" },
            { name: "Fatima Ibrahim", code: "BOPC/J1/003" }
        ],
        "SSS 1": [
            { name: "Olatunji Bola", code: "BOPC/S1/101" },
            { name: "Smith Sarah", code: "BOPC/S1/102" }
        ]
    };

    // SECURITY: PIN 1212, 3434 (Teachers) | 0099 (Principal)
    const _0x4f = ["MTIxMg==", "MzQzNA=="]; 
    const _0x5a = "MDA5OQ=="; 
    let activeUser = "";

    function checkAccess() {
        const pin = document.getElementById('pinInput').value;
        const encoded = btoa(pin);
        if (encoded === _0x5a || _0x4f.includes(encoded)) {
            activeUser = encoded === _0x5a ? "PRINCIPAL" : "STAFF-"+pin;
            document.getElementById('authOverlay').style.display = "none";
            document.getElementById('mainPortal').style.display = "block";
            document.getElementById('mainPortal').style.opacity = "1";
            document.getElementById('staffIDDisplay').innerText = activeUser;
        } else {
            alert("Invalid PIN!");
        }
    }

    function loadClassList() {
        const cls = document.getElementById('classSelect').value;
        const students = studentDatabase[cls];
        const body = document.getElementById('caBody');
        body.innerHTML = "";
        
        if(!students) return;

        students.forEach(s => {
            body.innerHTML += `<tr>
                <td class="stu-info"><b>${s.name}</b><br><small>${s.code}</small>
                    <input type="hidden" class="h-name" value="${s.name}">
                    <input type="hidden" class="h-code" value="${s.code}">
                </td>
                <td><input type="number" class="t1" oninput="calc(this)" max="10"></td>
                <td><input type="number" class="t2" oninput="calc(this)" max="10"></td>
                <td><input type="number" class="note" oninput="calc(this)" max="10"></td>
                <td><input type="number" class="extra" oninput="calc(this)" max="5"></td>
                <td><input type="number" class="inter" oninput="calc(this)" max="5"></td>
                <td class="row-total" style="font-weight:bold;">0</td>
                <td class="row-grade">-</td>
            </tr>`;
        });
    }

    function calc(el) {
        const row = el.closest('tr');
        const vals = [
            parseFloat(row.querySelector('.t1').value)||0,
            parseFloat(row.querySelector('.t2').value)||0,
            parseFloat(row.querySelector('.note').value)||0,
            parseFloat(row.querySelector('.extra').value)||0,
            parseFloat(row.querySelector('.inter').value)||0
        ];
        const total = vals.reduce((a,b)=>a+b, 0);
        row.querySelector('.row-total').innerText = total.toFixed(1);
        
        let grade = "F";
        if(total >= 30) grade = "A";
        else if(total >= 24) grade = "B";
        else if(total >= 20) grade = "C";
        
        row.querySelector('.row-grade').innerText = grade;
        row.querySelector('.row-grade').style.color = total >= 20 ? "green" : "red";
    }

    function exportCSV() {
        const subject = document.getElementById('subjectSelect').value;
        const cls = document.getElementById('classSelect').value;
        let csv = "Teacher,Class,Subject,StudentName,SchoolCode,Total,Grade\n";
        
        document.querySelectorAll('#caBody tr').forEach(r => {
            csv += `${activeUser},${cls},${subject},${r.querySelector('.h-name').value},${r.querySelector('.h-code').value},${r.querySelector('.row-total').innerText},${r.querySelector('.row-grade').innerText}\n`;
        });

        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${cls}_${subject}_Report.csv`;
        a.click();
    }

    function generateVisuals() {
        const canvas = document.getElementById('caChart');
        canvas.style.display = "block";
        const labels = Array.from(document.querySelectorAll('.h-name')).map(i => i.value);
        const data = Array.from(document.querySelectorAll('.row-total')).map(td => parseFloat(td.innerText));
        new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: { labels: labels, datasets: [{ label: 'Score out of 40', data: data, backgroundColor: '#0d47a1' }] }
        });
    }
</script>
</body>
</html>
